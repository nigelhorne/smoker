#!/usr/bin/env bash

# set -x
set -e
source $PERLBREW_ROOT/etc/bashrc

if [ -r $HOME/.cpanreporter/$PERLBREW_PERL/config.ini ]; then
	export PERL_CPAN_REPORTER_DIR=$HOME/.cpanreporter/$PERLBREW_PERL
fi

kernel=`uname`
if [[ "$kernel" != 'FreeBSD' && "$kernel" != 'OpenBSD' && "$kernel" != 'CYGWIN_NT-10.0' && `ulimit -d` = unlimited ]]; then
	ulimit -d 393216
fi
if [[ "$kernel" != 'SunOS' && "$kernel" != 'CYGWIN_NT-10.0' && `ulimit -m` = unlimited ]]; then
	ulimit -m 393216
	ulimit -u 256
fi
if [[ "$kernel" != 'CYGWIN_NT-10.0' ]]; then
	ulimit -f 300000
fi

NEWTMPDIR=${TMPDIR-/tmp}/testwrapper.$$
LOCKFILE=${TMPDIR-/tmp}/testwrapper.lck
if [ -e ${LOCKFILE} ] && kill -0 `cat ${LOCKFILE}`; then
	logger "$0: already running"
	exit
fi

echo $$ > ${LOCKFILE}

mkdir $NEWTMPDIR

# make sure the lockfile is removed when we exit and then claim it
trap "rm -fr ${LOCKFILE} ${NEWTMPDIR}; exit" INT TERM EXIT ALRM

TMPDIR=$NEWTMPDIR perl -MCPAN -e "CPAN::Shell->test($*)"
TMPDIR=$NEWTMPDIR perl -MCPAN -e "CPAN::Shell->clean($*)"

rm -f ${LOCKFILE}

rm -rf ${NEWTMPDIR}
