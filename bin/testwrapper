#!/usr/bin/env bash

# set -x
set -e
source $PERLBREW_ROOT/etc/bashrc

if [ -r $HOME/.cpanreporter/$PERLBREW_PERL/config.ini ]; then
	export PERL_CPAN_REPORTER_DIR=$HOME/.cpanreporter/$PERLBREW_PERL
fi

kernel=`uname`
if [[ "$kernel" != 'FreeBSD' && "$kernel" != 'OpenBSD' ]]; then
	ulimit -d 393216
fi
if [[ "$kernel" != 'SunOS' ]]; then
	ulimit -m 393216
fi
ulimit -f 200000
ulimit -u 256

LOCKFILE=${TMPDIR-/tmp}/lock.txt
if [ -e ${LOCKFILE} ] && kill -0 `cat ${LOCKFILE}`; then
	logger "$0: already running"
	exit
fi

echo $$ > ${LOCKFILE}

# make sure the lockfile is removed when we exit and then claim it
trap "rm -f ${LOCKFILE}; exit" INT TERM EXIT

perl -MCPAN -e "CPAN::Shell->test($*)"

rm -f ${LOCKFILE}
