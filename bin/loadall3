#!/usr/bin/env bash

if [ x$TMPDIR = 'x' ]; then
	if [[ -d $HOME/tmp ]]; then
		export TMPDIR=$HOME/tmp
	else
		export TMPDIR=/tmp
	fi
fi

LOCKFILE=${TMPDIR}/cpan-test.lck.pid
if test -s ${LOCKFILE} && kill -0 `cat ${LOCKFILE}`; then
	# echo "Already running"
	exit 0
fi

# make sure the lockfile is removed when we exit and then claim it
trap "rm -f ${LOCKFILE}; exit" INT TERM ALRM EXIT
echo $$ > ${LOCKFILE}

# Stage 3
. ~/perl5/perlbrew/etc/bashrc

rm -rf $HOME/.cpan/build/*&

export CPAN_SQLITE_NO_LOG_FILES=1
unset CC CFLAGS LDFLAGS

perlbrew switch-off

if [ $1x == x ]; then
	LIST=`perlbrew list | awk '{ print $1; }'`
else
	LIST=$*
fi

for i in $LIST
do
	if [ ! -d $PERLBREW_ROOT/perls/$i ]; then
		continue
	fi

	perlbrew use $i

	echo $i:

	if [ -r $HOME/.cpanreporter/perl-$i/config.ini ]; then
		export PERL_CPAN_REPORTER_DIR=$HOME/.cpanreporter/perl-$i
	else
		unset PERL_CPAN_REPORTER_DIR
	fi
	perl -MCPAN -e 'CPAN::Shell->install("YAML::Syck", "App::Cpan", "CPAN::SQLite")'
	HARNESS_OPTIONS=c TEST_JOBS= perl -MCPAN -e 'CPAN::Shell->install("App::Cpan", "CPAN::SQLite")'
	# perl -MCPAN -e 'CPAN::Shell->upgrade'
done

rm -f ${LOCKFILE}
